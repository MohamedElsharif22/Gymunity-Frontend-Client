<div class="flex flex-col h-full bg-white overflow-hidden">
  <!-- Chat Header with Gradient Background - Hidden on mobile since it's in parent -->
  @if (selectedThread()) {
    <div class="hidden md:flex bg-gradient-to-r from-sky-500 to-indigo-600 px-3 sm:px-4 py-2.5 sm:py-3 items-center justify-between shadow-md backdrop-blur-sm sticky top-0 z-10">
      <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
        <!-- Avatar with Status -->
        <div class="relative shrink-0">
          @if (selectedThread()?.otherUserProfilePhoto) {
            <img
              [src]="selectedThread()?.otherUserProfilePhoto"
              [alt]="selectedThread()?.otherUserName"
              title="User profile"
              class="w-7 h-7 sm:w-9 sm:h-9 rounded-full object-cover ring-2 ring-white/30"
            />
          } @else {
            <div
              class="w-7 h-7 sm:w-9 sm:h-9 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-semibold text-xs ring-2 ring-white/30"
            >
              {{ getInitials(selectedThread()?.otherUserName || '') }}
            </div>
          }
          @if (selectedThread()?.isOnline) {
            <div class="absolute -bottom-0.5 -right-0.5 w-2 h-2 sm:w-2.5 sm:h-2.5 bg-green-400 rounded-full ring-2 ring-white animate-pulse"></div>
          }
        </div>

        <!-- Thread Info -->
        <div class="min-w-0">
          <h3 class="text-white font-bold text-xs sm:text-sm md:text-base truncate">{{ selectedThread()?.otherUserName }}</h3>
          <p class="text-xs text-blue-100/80 flex items-center gap-1">
            @if (selectedThread()?.isOnline) {
              <span class="inline-block w-1 h-1 sm:w-1.5 sm:h-1.5 bg-green-400 rounded-full"></span>
              <span class="hidden xs:inline">Active now</span>
              <span class="xs:hidden">Online</span>
            } @else {
              <span>Offline</span>
            }
          </p>
        </div>
      </div>

      <!-- Action Buttons - Hidden on mobile to save space -->
      <div class="hidden sm:flex gap-1 shrink-0">
        <button
          class="p-1.5 hover:bg-white/20 rounded-lg transition-all duration-200 group relative"
          title="Start call"
        >
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 5a2 2 0 012-2h3.28a1 1 0 00.948-.684l1.498-4.493a1 1 0 011.502-.684l1.498 4.493a1 1 0 00.948.684H17a2 2 0 012 2v2.5"
            />
          </svg>
          <span class="absolute -bottom-8 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Call</span>
        </button>
        <button
          class="p-1.5 hover:bg-white/20 rounded-lg transition-all duration-200 group relative"
          title="View info"
        >
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <span class="absolute -bottom-8 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Info</span>
        </button>
      </div>
    </div>
  }

  <!-- Messages Container -->
  <div #messagesContainer class="flex-1 overflow-y-auto px-2 sm:px-3 md:px-4 py-3 sm:py-4 space-y-2 sm:space-y-3 bg-gradient-to-b from-white via-blue-50/30 to-indigo-50/30 scroll-smooth">
    @if (messages().length === 0) {
      <div class="flex flex-col items-center justify-center h-full text-gray-400">
        <div class="mb-3 p-3 sm:p-4 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100">
          <svg
            class="w-10 h-10 sm:w-12 sm:h-12 text-blue-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
            />
          </svg>
        </div>
        <p class="text-center text-xs sm:text-sm font-medium text-gray-500">No messages yet</p>
        <p class="text-center text-xs text-gray-400 mt-1">Start the conversation!</p>
      </div>
    } @else {
      @for (message of messages(); track message.id || $index) {
        <div [class.flex-row-reverse]="message.isOwn" class="flex gap-1.5 sm:gap-2.5 md:gap-3 animate-fade-in mb-1">
          <!-- Avatar -->
          <div class="shrink-0 flex-shrink-0">
            @if (message.isOwn) {
              @if (currentUser() && currentUser()?.profilePhotoUrl) {
                <img
                  [src]="currentUser()?.profilePhotoUrl"
                  [alt]="currentUser()?.name"
                  title="Your profile"
                  class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 rounded-full object-cover ring-2 ring-blue-200"
                />
              } @else {
                <div
                  class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 rounded-full bg-gradient-to-br from-sky-400 to-sky-600 flex items-center justify-center text-white text-xs font-semibold ring-2 ring-sky-200"
                >
                  {{ getInitials(currentUser()?.name || 'You') }}
                </div>
              }
            } @else {
              @if (message.senderProfilePhoto) {
                <img
                  [src]="message.senderProfilePhoto"
                  [alt]="message.senderName"
                  title="Sender profile"
                  class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 rounded-full object-cover ring-2 ring-green-200"
                />
              } @else {
                <div
                  class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xs font-semibold ring-2 ring-green-200"
                >
                  {{ getInitials(message.senderName) }}
                </div>
              }
            }
          </div>

          <!-- Message Content -->
          <div
            [class.items-end]="message.isOwn"
            [class.items-start]="!message.isOwn"
            class="flex flex-col gap-0.5 max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg"
          >
            @if (!message.isOwn) {
              <p class="text-xs text-gray-600 font-semibold px-2 sm:px-3 mb-0.5">{{ message.senderName }}</p>
            }
            <!-- Message Bubble -->
            <div
              [class.bg-gradient-to-br]="message.isOwn"
              [class.from-sky-500]="message.isOwn"
              [class.to-indigo-600]="message.isOwn"
              [class.text-white]="message.isOwn"
              [class.shadow-sky]="message.isOwn"
              [class.bg-gray-100]="!message.isOwn"
              [class.text-gray-900]="!message.isOwn"
              [class.shadow-gray]="!message.isOwn"
              class="px-3 sm:px-4 py-2 sm:py-2.5 rounded-2xl shadow-sm transition-all duration-150 hover:shadow-md break-words"
            >
              @if (message.mediaUrl && message.type !== 1) {
                <div class="mb-2 flex items-center gap-2">
                  <span class="text-lg sm:text-xl">
                    {{ getMessageTypeIcon(message.type) }}
                  </span>
                  <a [href]="message.mediaUrl" target="_blank" class="font-medium text-xs sm:text-sm underline hover:no-underline transition-all">
                    Download
                  </a>
                </div>
              }
              <p class="text-xs sm:text-sm break-words leading-relaxed">{{ message.content }}</p>
              <p
                [class.text-blue-100]="message.isOwn"
                [class.text-gray-500]="!message.isOwn"
                class="text-xs mt-1.5 flex items-center justify-end gap-1"
              >
                {{ formatTime(message.createdAt) }}
                @if (message.isOwn && message.isRead) {
                  <span [class.text-blue-200]="message.isOwn" title="Read">
                    <svg class="w-3 h-3 sm:w-3.5 sm:h-3.5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  </span>
                }
              </p>
            </div>
          </div>
        </div>
      }
    }
  </div>

  <!-- Message Input Area -->
  <div class="bg-gradient-to-t from-blue-50/80 to-white border-t border-blue-100 px-2 sm:px-3 md:px-4 py-2.5 sm:py-3 shrink-0 backdrop-blur-sm">
    <div class="flex items-end gap-1.5 sm:gap-2 md:gap-3">
      <!-- Emoji Button - Hide on very small screens -->
      <button
        class="hidden xs:block p-1.5 sm:p-2 text-gray-500 hover:text-sky-600 hover:bg-sky-100 rounded-full transition-all duration-200 shrink-0 group relative active:scale-95"
        title="Add emoji"
      >
        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
      </button>

      <!-- Attachment Button - Hide on very small screens -->
      <button
        class="hidden xs:block p-1.5 sm:p-2 text-gray-500 hover:text-sky-600 hover:bg-sky-100 rounded-full transition-all duration-200 shrink-0 group relative active:scale-95"
        title="Attach file"
      >
        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"
          />
        </svg>
      </button>

      <!-- Message Input -->
      <textarea
        [value]="messageText()"
        (input)="onMessageInputChange($event)"
        (keydown)="onKeyDown($event)"
        [disabled]="!selectedThread()"
        placeholder="Type a message..."
        class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 text-xs sm:text-sm border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent focus:shadow-md resize-none disabled:bg-gray-100 disabled:cursor-not-allowed transition-all duration-200 bg-white"
        rows="1"
      ></textarea>

      <!-- Send Button -->
      <button
        (click)="onSendMessage()"
        [disabled]="!messageText().trim() || !selectedThread()"
        class="px-2.5 sm:px-3.5 md:px-4 py-2 sm:py-2.5 bg-gradient-to-r from-sky-500 to-indigo-600 text-white rounded-full hover:from-sky-600 hover:to-indigo-700 hover:shadow-lg transition-all duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:hover:shadow-none font-semibold flex items-center justify-center gap-1 shrink-0 text-xs sm:text-sm active:scale-95"
        title="Send message"
      >
        @if (!isSending()) {
          <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 md:w-5 md:h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 L4.13399899,1.16585689 C3.34915502,0.9 2.40734225,0.9 1.77946707,1.4726235 C0.994623095,2.0452470 0.837654326,3.0878314 1.15159189,3.87332833 L3.03521743,10.3143213 C3.03521743,10.4714187 3.19218622,10.6285161 3.50612381,10.6285161 L16.6915026,11.4140031 C16.6915026,11.4140031 17.1624089,11.4140031 17.1624089,12.0868686 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"/>
          </svg>
        } @else {
          <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 md:w-5 md:h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
        }
      </button>
    </div>
  </div>
</div>
